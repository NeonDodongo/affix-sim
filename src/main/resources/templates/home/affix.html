<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">

<head>
    <title th:text="${title}"></title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
<!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
          integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous"/>
    <link rel="stylesheet" th:href="@{/css/custom.css}"/>
    <link type="text/javascript" th:href="@{/js/custom.js}"/>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
            integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
            integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
            crossorigin="anonymous"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script th:src="@{/js/custom.js}"></script>
    <script th:inline="javascript">
    //<![CDATA[

    var abilities = [[${abilities}]];
    var stage = [[${stage.equipment}]];

    $(document).ready(function(){


        $("#basic, #special, #soul, #resist, #status, #other").dblclick(function() {

            // Get selected ability
            var abilityTypeElement = document.getElementById(this.id);
            var selectedAbilityId = abilityTypeElement.options[abilityTypeElement.selectedIndex].value;
            var selectedAbility = abilities[selectedAbilityId - 1];

            console.log("Selected: " + selectedAbility.name);

            // Set current equipment
            var currentEquipment = stage[intEquipId];
            var currentAbilities = currentEquipment.abilities;

            if (!currentAbilities.includes(selectedAbility)) {

                if (currentEquipment.slots > 0) {

                    for(i=0; i<currentAbilities.length; i++) {
                        var switchable = false;

                        if (currentAbilities[i].abilityType == selectedAbility.abilityType) {

                            var currentType = selectedAbility.abilityType;

                            // Special replacement cases
                            if (currentType == "special") {

                                if ((selectedAbility.name.includes("Modulator") || selectedAbility.name.includes("Vinculum") || selectedAbility.name.includes("ARKS Max")) &&
                                    (currentAbilities[i].name.includes("Modulator") || currentAbilities[i].name.includes("Vinculum") || currentAbilities[i].name.includes("ARKS Max")))
                                {
                                        switchable = true;
                                        break;
                                }
                                else if ((selectedAbility.name.includes("Boost") || selectedAbility.name.includes("Noble") || selectedAbility.name.includes("Elegant")) &&
                                         (currentAbilities[i].name.includes("Boost") || currentAbilities[i].name.includes("Noble") || currentAbilities[i].name.includes("Elegant")))
                                {
                                    switchable = true;
                                    break;
                                }
                                else if (selectedAbility.name.includes("Factor") && currentAbilities[i].name.includes("Factor")) {
                                    switchable = true;
                                    break;
                                }
                                else if (selectedAbility.name.includes("Reverie") && currentAbilities[i].name.includes("Reverie")) {
                                    switchable = true;
                                    break;
                                }
                                else if ((selectedAbility.name.includes("Flict") || selectedAbility.name.includes("Alter")) &&
                                         (currentAbilities[i].name.includes("Flict") || currentAbilities[i].name.includes("Alter")))
                                {
                                    switchable = true;
                                    break;
                                }
                            }
                            else if (currentType == "soul" || currentType == "fever") {
                                switchable = true;
                                break;
                            }
                            else {
                                var splitSelected = selectedAbility.name.split(" ");
                                var splitCurrent = currentAbilities[i].name.split(" ");

                                if (splitSelected[0] == splitCurrent[0]) {
                                    switchable = true;
                                    break;
                                }
                            }
                        }

                    } //end for

                        if (switchable) {
                            currentAbilities[i] = selectedAbility;
                            // renders ability name to corresponding equipment
                            $("#" + currentAbilities.indexOf(selectedAbility) + "-" + strEquipId).text(selectedAbility.name);
                        }
                        else {
                            if (currentEquipment.slots < 8) {
                                currentAbilities.push(selectedAbility);
                                $("#" + currentAbilities.indexOf(selectedAbility) + "-" + strEquipId).text(selectedAbility.name);
                                currentEquipment.slots++;
                            }
                            else {
                                console.log("Maximum slots allotted: " + currentEquipment.length)
                            }
                        }
                }
                else {
                    currentAbilities.push(selectedAbility);
                    $("#" + currentAbilities.indexOf(selectedAbility) + "-" + strEquipId).text(selectedAbility.name);
                    currentEquipment.slots++;
                }
            }
            console.log(currentEquipment);
        });

        $("#affix-header").click(function() {

            if (affixing) {

                var abilityMap = {};
                var soulMap = {};
                var ready = false;

                for (i=1; i<stage.length; i++) {
                    if (stage[0].slots > 0) {
                        if (stage[0].slots <= stage[i].slots || stage[i].slots == 0) {
                            ready = true;
                            continue;
                        }
                        else {
                            console.log("Cannot Affix...");
                            ready = false;
                            break;
                        }
                    }
                    else if (stage[0].slots == 0) {
                        if (stage[i].slots > 0) {
                            console.log("All other equipment must at least have the same amount of slots as the base.");
                            ready = false;
                            break;
                        }
                    }
                }
                if (ready) {
                    console.log("Can Affix!");
                    for (j=0; j<stage.length; j++) {
                        if (stage[j].slots > 0) {
                            for (k=0; k<stage[j].slots; k++) {
                                var currentAbility = stage[j].abilities[k];
                                if (!abilityMap[currentAbility.id]) {
                                    abilityMap[currentAbility.id] = 1;
                                }
                                else {
                                    abilityMap[currentAbility.id] += 1;
                                }
                                if (currentAbility.abilityType.includes("soul")) {
                                    if (!soulMap[currentAbility.id]) {
                                        soulMap[currentAbility.id] = 1;
                                    }
                                    else {
                                        soulMap[currentAbility.id] += 1;
                                    }
                                }
                            }
                        }
                    }

                    console.log(abilityMap);

                    /** TODO : Create algorithm to calculate "true" ability success rates and extra ability creation */
                    for (var id in abilityMap) {
                        var ability = abilities[id-1];
                        var actualRate = 0;
                        var newRate = 0;
                        var splitName = ability.name.split(" ");
                        var fusionDict = {};

                        /** Specific checks for increased success rates */

                        /**Individuals*/
                        if (ability.name.includes("Modulator")) {
                            if (abilityMap[id] == 2) {
                                actualRate = 30;
                            }
                            else if (abilityMap[id] > 2) {
                                actualRate = 80;
                            }
                        }
                        else if (ability.name.includes("Stigma") || ability.name.includes("Vinculum") || ability.name.includes("ARKS Max")) {
                            if (abilityMap[id] == 2) {
                                actualRate = 30;
                            }
                            else if (abilityMap[i] > 2) {
                                actualRate = 50;
                            }
                        }

                        else if (ability.name.includes("Flict") || ability.name.includes("Alter")) {
                            if (abilityMap[id] > 2) {
                                actualRate = 80;
                            }
                        }

                        else if (ability.abilityType.includes("soul")) {
                            if (abilityMap[id] == 2) {
                                actualRate = 50;
                            }
                            else if (abilityMap[id] > 2) {
                                actualRate = 80;
                            }
                        }

                        else if (ability.name.includes("Mutation") || ability.name.includes("Doom Break")) {
                            if (abilityMap[id] == 2) {
                                actualRate = 50;
                            }
                            else if (abilityMap[id] > 2) {
                                actualRate = 80;
                            }
                        }

                        else if (ability.abilityType.includes("basic") || ability.abilityType.includes("resist") || ability.abilityType.includes("status")) {
                            if (abilityMap[id] == 2) {
                                actualRate = 20;
                                fusionDict[abilities[id].name] = abilities[id].successRate;
                            }
                            else if (abilityMap[id] > 2) {
                                actualRate = 40;
                                fusionDict[abilities[id].name] = abilities[id].successRate + 20;
                            }
                        } /** End of individual checks */


                        /** Soul bonus check */
                        for (var soulId in soulMap) {
                            if (abilities[soulId-1].boost.includes(splitName[0])) {
                                actualRate += 20
                                break;
                            }
                        }

                        newRate = ability.successRate + actualRate;

                        /**Overall success rate cannot exceed 100% */
                        if (newRate > 100) {
                            newRate = 100;
                        }

                        console.log(newRate);

                        if (newRate > 0 || ability.successRate > 0) {

                            $("#pot-affix").append("<tr><span><td>" + abilities[id-1].name + "</td><td>" + "---" + newRate +
                                                    "%" + "</td><td>---<input value='" + id +
                                                    "' type='checkbox' /></td></span></tr>");

                            if (fusionDict) {
                                for (var name in fusionDict) {
                                    $("#pot-affix").append("<tr><span><td>" + name + "</td><td>" + "---" + fusionDict[name] +
                                                    "%" + "</td><td>---<input value='" + id +
                                                    "' type='checkbox' /></td></span></tr>");
                                }
                            }
                        }
                    } // end for
                }
            }
        });
    });

    //]]>
    </script>
</head>


<body>

    <div th:replace="fragments :: navigation" style="position: fixed;"></div>

    <div class="container-fluid" id="header">
        <h1 class="display-2" style="text-shadow:.7px 1.4px teal">PSO2 Affix Simulator</h1>
    </div>

    <div class="col-xs-12" style="height:25px;">
        <!-- Empty Space -->
    </div>


    <div class="container-fluid" id="stage-header-cont">

        <h2 id="stage-header" class="display-4">Stage</h2>

    </div>

    <div id="stage" class="container-fluid">
        <div th:each="equipment : ${stage.equipment}"
             th:id="${equipment.identifier}"
             class="col-sm-2 equipment">

            <h2 class="equipment-header" th:text="${equipment.title}"></h2>

            <div class="justify-content-around">
                <button th:id="'add-' + ${equipment.identifier}" class="btn">Add</button>
                <button th:id="'clear-' + ${equipment.identifier}" class="btn">Clear</button>
                <button th:id="'junk-' + ${equipment.identifier}" class="btn">Junk</button>
            </div>

            <table th:id="'table-' + ${equipment.identifier}">
                <tr th:id="'0-' + ${equipment.identifier}"></tr>
                <tr th:id="'1-' + ${equipment.identifier}"></tr>
                <tr th:id="'2-' + ${equipment.identifier}"></tr>
                <tr th:id="'3-' + ${equipment.identifier}"></tr>
                <tr th:id="'4-' + ${equipment.identifier}"></tr>
                <tr th:id="'5-' + ${equipment.identifier}"></tr>
                <tr th:id="'6-' + ${equipment.identifier}"></tr>
                <tr th:id="'7-' + ${equipment.identifier}"></tr>
            </table>

        </div>


        <div id="search">
            <h2>Double-Click Ability to Add</h2>
            <br />
            <div class="column">
                <h5 class="ability-header">Basic</h5>
                <select id="basic" size="13">
                    <option class="ability"
                            th:each="ability : ${basic}"
                            th:value="${ability.id}"
                            th:text="${ability.name}">
                    </option>
                </select>
            </div>
            <div class="column">
                <h5 class="ability-header">Special</h5>
                <select multiple="multiple" id="special" size="13">
                    <option th:each="ability : ${special}"
                            th:value="${ability.id}"
                            th:text="${ability.name}">
                    </option>
                </select>
            </div>
            <div class="column">
                <h5 class="ability-header">Souls</h5>
                <select multiple="multiple" id="soul" size="13">
                    <option th:each="ability : ${soul}"
                            th:value="${ability.id}"
                            th:text="${ability.name}">
                    </option>
                </select>
            </div>
            <div class="column">
                <h5 class="ability-header">Resists</h5>
                <select multiple="multiple" id="resist" size="13">
                    <option th:each="ability : ${resist}"
                            th:value="${ability.id}"
                            th:text="${ability.name}"></option>
                </select>
            </div>
            <div class="column">
                <h5 class="ability-header">Status Effects</h5>
                <select multiple="multiple" id="status" size="13">
                    <option th:each="ability : ${status}"
                            th:value="${ability.id}"
                            th:text="${ability.name}"></option>
                </select>
            </div>
            <div class="column">
                <h5 class="ability-header">Other</h5>
                <select multiple="multiple" id="other" size="13">
                    <option th:each="ability : ${other}"
                            th:value="${ability.id}"
                            th:text="${ability.name}"></option>
                </select>
            </div>
        </div>

    </div>

    <!-- End Stage -->


    <div class="container-fluid" id="affix-header-cont">
        <h2 id="affix-header" class="display-4">Affix</h2>
    </div>

    <div id="affix">
        <h4>Choose Abilities:</h4>
        <table id="pot-affix"></table>
    </div>

</body>
</html>